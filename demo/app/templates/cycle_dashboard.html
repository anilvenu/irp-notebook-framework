{% extends "base.html" %}

{% block title %}{{ cycle_name }} - Cycle Dashboard{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="/{{ schema }}/">Home</a>
    <span class="breadcrumb-separator">›</span>
    <span class="breadcrumb-current">{{ cycle_name }}</span>
</div>
{% endblock %}

{% block content %}
{% if not error %}
<div class="page-header">
    <h2>Moody's Risk Modeling Dashboard</h2>
    <p>Cycle: <strong>{{ cycle_name }}</strong></p>
</div>

<!-- Summary Statistics Cards -->
{% set stats = {
    'total_batches': batches|length,
    'completed_batches': batches|selectattr('reporting_status', 'equalto', 'COMPLETED')|list|length,
    'total_jobs': batches|sum(attribute='total_jobs', start=0)|int,
    'finished_jobs': batches|sum(attribute='finished_jobs', start=0)|int,
    'failed_jobs': batches|sum(attribute='failed_jobs', start=0)|int,
    'error_jobs': batches|sum(attribute='error_jobs', start=0)|int,
    'total_configs': batches|sum(attribute='total_configs', start=0)|int,
    'fulfilled_configs': batches|sum(attribute='fulfilled_configs', start=0)|int,
    'unfulfilled_configs': batches|sum(attribute='unfulfilled_configs', start=0)|int,
    'skipped_configs': batches|sum(attribute='skipped_configs', start=0)|int
} %}
{% set stats = stats.update({'not_completed_batches': stats.total_batches - stats.completed_batches}) or stats %}
{% set stats = stats.update({'not_finished_jobs': stats.total_jobs - stats.finished_jobs}) or stats %}
{% set stats = stats.update({'cycle_status': 'COMPLETED' if stats.not_completed_batches == 0 else 'INCOMPLETE'}) or stats %}

<div class="info-grid">
    <div class="info-card">
        <div class="info-label">Cycle Status</div>
        <div class="info-value">
            <span class="status-badge status-{{ stats.cycle_status }}">{{ stats.cycle_status }}</span>
        </div>
    </div>

    <div class="info-card">
        <div class="info-label">Batches</div>
        <div class="info-value">{{ stats.total_batches }}</div>
        <div class="info-detail">{{ stats.completed_batches }} completed, {{ stats.not_completed_batches }} not completed</div>
    </div>

    <div class="info-card">
        <div class="info-label">Jobs</div>
        <div class="info-value">{{ stats.total_jobs }}</div>
        <div class="info-detail">Finished: {{ stats.finished_jobs }}, Not Finished: {{ stats.not_finished_jobs }}</div>
    </div>

    <div class="info-card">
        <div class="info-label">Configurations</div>
        <div class="info-value">{{ stats.total_configs }}</div>
        <div class="info-detail">Fulfilled: {{ stats.fulfilled_configs }}, Unfulfilled: {{ stats.unfulfilled_configs }}, Skipped: {{ stats.skipped_configs }}</div>
    </div>
</div>

<!-- Batch List -->
<div class="batch-list">
    <h3>Batches ({{ batches|length }})</h3>

    <table class="data-table">
        <thead>
            <tr>
                <th>Batch ID</th>
                <th>Batch Type</th>
                <th>Stage</th>
                <th>Step</th>
                <th>Status</th>
                <th>Total Jobs</th>
                <th>Finished</th>
                <th>Job Alerts</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for batch in batches %}
            <tr>
                <td>
                    <a href="/{{ schema }}/cycle/{{ cycle_name }}/batch/{{ batch.batch_id }}" class="batch-link">
                        {{ batch.batch_id }}
                    </a>
                </td>
                <td>{{ batch.batch_type }}</td>
                <td>{{ batch.stage_name }}</td>
                <td>{{ batch.step_name }}</td>
                <td>
                    <span class="status-badge status-{{ batch.reporting_status }}">
                        {{ batch.reporting_status }}
                    </span>
                </td>
                <td>{{ batch.total_jobs }}</td>
                <td>{{ batch.finished_jobs }}</td>
                <td class="{% if batch.failed_jobs > 0 or batch.error_jobs > 0 %}alert-cell{% endif %}">
                    {% set alerts = [] %}
                    {% if batch.failed_jobs > 0 %}{% set _ = alerts.append('⚠ Failures (' ~ batch.failed_jobs ~ ')') %}{% endif %}
                    {% if batch.error_jobs > 0 %}{% set _ = alerts.append('⚠ Errors (' ~ batch.error_jobs ~ ')') %}{% endif %}
                    {% if batch.skipped_jobs > 0 %}{% set _ = alerts.append('⚠ Skipped (' ~ batch.skipped_jobs ~ ')') %}{% endif %}
                    {{ alerts|join(', ') if alerts else '-' }}
                </td>
                <td>{{ format_timestamp(batch.created_ts) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endif %}
{% endblock %}

{% block extra_head %}
<style>
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 24px 0;
}

.info-card {
    background: white;
    border-radius: 6px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.info-label {
    font-size: 12px;
    color: #757575;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.info-value {
    font-size: 28px;
    font-weight: bold;
    color: #212121;
    margin-bottom: 4px;
}

.info-detail {
    font-size: 12px;
    color: #757575;
}

.batch-list {
    background: white;
    border-radius: 6px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-top: 24px;
}

.batch-list h3 {
    font-size: 16px;
    margin-bottom: 16px;
    color: #37474f;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 8px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead th {
    background: #f5f5f5;
    padding: 12px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: #616161;
    border-bottom: 2px solid #e0e0e0;
}

.data-table tbody td {
    padding: 12px;
    border-bottom: 1px solid #e0e0e0;
    font-size: 13px;
}

.data-table tbody tr:hover {
    background: #fafafa;
}

.batch-link {
    color: #1976d2;
    text-decoration: none;
    font-weight: 500;
}

.batch-link:hover {
    text-decoration: underline;
}

.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
}

.status-COMPLETED {
    background: #e8f5e9;
    color: #2e7d32;
}

.status-INCOMPLETE {
    background: #fff3e0;
    color: #f57c00;
}

.status-ACTIVE {
    background: #e3f2fd;
    color: #1565c0;
}

.status-FAILED {
    background: #ffebee;
    color: #c62828;
}

.status-ERROR {
    background: #fce4ec;
    color: #ad1457;
}

.alert-cell {
    font-size: 12px;
    color: #d32f2f;
}
</style>
{% endblock %}
