{% extends "base.html" %}

{% block title %}{{ cycle_name }} - Cycle Dashboard{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="/{{ schema }}/">Home</a>
    <span class="breadcrumb-separator">›</span>
    <span class="breadcrumb-current">{{ cycle_name }}</span>
</div>
{% endblock %}

{% block content %}
{% if not error %}
<div class="page-header">
    <h2>Moody's Risk Modeling Dashboard</h2>
    <p>Cycle: <strong>{{ cycle_name }}</strong></p>
</div>

<!-- Summary Statistics Cards -->
{% set stats = {
    'total_batches': batches|length,
    'completed_batches': batches|selectattr('reporting_status', 'equalto', 'COMPLETED')|list|length,
    'total_jobs': batches|sum(attribute='total_jobs', start=0)|int,
    'finished_jobs': batches|sum(attribute='finished_jobs', start=0)|int,
    'failed_jobs': batches|sum(attribute='failed_jobs', start=0)|int,
    'error_jobs': batches|sum(attribute='error_jobs', start=0)|int,
    'total_configs': batches|sum(attribute='total_configs', start=0)|int,
    'fulfilled_configs': batches|sum(attribute='fulfilled_configs', start=0)|int,
    'unfulfilled_configs': batches|sum(attribute='unfulfilled_configs', start=0)|int,
    'skipped_configs': batches|sum(attribute='skipped_configs', start=0)|int
} %}
{% set stats = stats.update({'not_completed_batches': stats.total_batches - stats.completed_batches}) or stats %}
{% set stats = stats.update({'not_finished_jobs': stats.total_jobs - stats.finished_jobs}) or stats %}
{% set stats = stats.update({'cycle_status': 'COMPLETED' if stats.not_completed_batches == 0 else 'INCOMPLETE'}) or stats %}

<div class="info-grid">
    <div class="info-card">
        <div class="info-label">Cycle Status</div>
        <div class="info-value">
            <span class="status-badge status-{{ stats.cycle_status }}">{{ stats.cycle_status }}</span>
        </div>
    </div>

    <div class="info-card">
        <div class="info-label">Batches</div>
        <div class="info-value">{{ stats.total_batches }}</div>
        <div class="info-detail">{{ stats.completed_batches }} completed, {{ stats.not_completed_batches }} not completed</div>
    </div>

    <div class="info-card">
        <div class="info-label">Jobs</div>
        <div class="info-value">{{ stats.total_jobs }}</div>
        <div class="info-detail">Finished: {{ stats.finished_jobs }}, Not Finished: {{ stats.not_finished_jobs }}</div>
    </div>

    <div class="info-card">
        <div class="info-label">Configurations</div>
        <div class="info-value">{{ stats.total_configs }}</div>
        <div class="info-detail">Fulfilled: {{ stats.fulfilled_configs }}, Unfulfilled: {{ stats.unfulfilled_configs }}, Skipped: {{ stats.skipped_configs }}</div>
    </div>
</div>

<!-- Batch List -->
<div class="batch-list">
    <h3>Batches ({{ batches|length }})</h3>

    <div class="table-container">
        <!-- Filter Controls -->
        <div class="filter-controls">
            <button class="filter-toggle-btn" onclick="toggleFilterRow('batchesTable')">Show Filters</button>
            <button class="clear-filters-btn" onclick="clearFilters('batchesTable')">Clear Filters</button>
        </div>

        <table class="data-table" id="batchesTable">
            <thead>
                <tr>
                    <th class="sortable" onclick="sortTable('batchesTable', 0)">Batch ID</th>
                    <th class="sortable" onclick="sortTable('batchesTable', 1)">Batch Type</th>
                    <th class="sortable" onclick="sortTable('batchesTable', 2)">Stage</th>
                    <th class="sortable" onclick="sortTable('batchesTable', 3)">Step</th>
                    <th class="sortable" onclick="sortTable('batchesTable', 4)">Status</th>
                    <th class="sortable" onclick="sortTable('batchesTable', 5)">Total Jobs</th>
                    <th class="sortable" onclick="sortTable('batchesTable', 6)">Finished</th>
                    <th class="sortable" onclick="sortTable('batchesTable', 7)">Job Alerts</th>
                    <th class="sortable" onclick="sortTable('batchesTable', 8)">Created</th>
                </tr>
            </thead>
            <tbody>
                {% for batch in batches %}
                <tr>
                    <td>
                        <a href="/{{ schema }}/cycle/{{ cycle_name }}/batch/{{ batch.batch_id }}" class="batch-link">
                            {{ batch.batch_id }}
                        </a>
                    </td>
                    <td>{{ batch.batch_type }}</td>
                    <td>{{ batch.stage_name }}</td>
                    <td>{{ batch.step_name }}</td>
                    <td>
                        <span class="status-badge status-{{ batch.reporting_status }}">
                            {{ batch.reporting_status }}
                        </span>
                    </td>
                    <td>{{ batch.total_jobs|int }}</td>
                    <td>{{ batch.finished_jobs|int }}</td>
                    <td class="{% if batch.failed_jobs > 0 or batch.error_jobs > 0 %}alert-cell{% endif %}">
                        {% set alerts = [] %}
                        {% if batch.failed_jobs > 0 %}{% set _ = alerts.append('⚠ Failures (' ~ batch.failed_jobs|int ~ ')') %}{% endif %}
                        {% if batch.error_jobs > 0 %}{% set _ = alerts.append('⚠ Errors (' ~ batch.error_jobs|int ~ ')') %}{% endif %}
                        {% if batch.skipped_jobs > 0 %}{% set _ = alerts.append('⚠ Skipped (' ~ batch.skipped_jobs|int ~ ')') %}{% endif %}
                        {{ alerts|join(', ') if alerts else '-' }}
                    </td>
                    <td>{{ format_timestamp(batch.created_ts) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_head %}{% endblock %}
